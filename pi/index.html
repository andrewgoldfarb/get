#! /bin/sh
#
# curl -Ls http://cloudmesh.github.io/get/pi | sh
#
# <pre>
start=`date +%s`

NORMAL='\033[0m'
RED='\033[0;31m'

if [[ -z "${VERSION}" ]]; then
    VERSION='3.8.2'
else
    VERSION=$1
fi

PYTHON=PYTHON${VERSION}


AddToBashrc(){
grep -qF -- "${1}" ~/.bashrc || echo "${1}" >> "${HOME}/.bashrc"
}

Echo() {
 echo "${RED}${1}${NORMAL}"
}

Echo "#################################################"
Echo "# Raspbery Pi Cloudmesh Cluster Instalation     #"
Echo "#################################################"
echo
echo
Echo "# -----------------------------------------------"
Echo "# Update the system"
Echo "# -----------------------------------------------"
sudo apt-get update
sudo apt-get full-upgrade
sudo apt-get install -y libatlas-base-dev
sudo apt-get install -y nmap
echo
Echo "# -----------------------------------------------"
Echo "# Create a Python Virtual Env ~/ENV3"
Echo "# -----------------------------------------------"
${PYTHON} -m venv ~/ENV3
. ${HOME}/ENV3/bin/activate
pip install pip -U
which python
which pip
python3 --version
pip --version
echo
Echo "# -----------------------------------------------"
Echo "# Install cloudmesh"
Echo "# -----------------------------------------------"
pip install cloudmesh-installer -U
mkdir -p ${HOME}/cm
cd ${HOME}/cm
cloudmesh-installer get pi

cd ${HOME}

Echo "# -----------------------------------------------"
Echo "# Create ssh key if it does not exist"
Echo "# -----------------------------------------------"
FILE=$HOME/.ssh/id_rsa.pub
if [ ! -e "$FILE" ]; then
     yes y | ssh-keygen -q -N "" -f .ssh/id_rsa
fi
echo
Echo "# -----------------------------------------------"
Echo "# Update .bashrc"
Echo "# -----------------------------------------------"
echo
AddToBashrc 'source ${HOME}/ENV3/bin/activate'  
AddToBashrc 'if [ -z "$SSH_AUTH_SOCK" ] ; then eval "$(ssh-agent -s)"; fi'
AddToBashrc "ssh-add"

Echo "#################################################"
Echo "# Install Completed                             #"
Echo "#################################################"
end=`date +%s`
runtime=$((end-start))
echo
echo "Time to install:" ${runtime} s
echo
Echo "#################################################"

echo
Echo "Please activate with"
echo
Echo "    source ~/ENV3/bin/activate"
echo
exit 0

# </pre>

