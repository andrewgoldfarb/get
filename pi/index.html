#! /bin/sh

# curl -Ls http://cloudmesh.github.io/get/pi | sh

# <pre>
NORMAL='\033[0m'
RED='\033[0;31m'

Echo() {
 echo "${RED}${1}${NORMAL}"
}

Echo "#################################################"
Echo "# Raspbery Pi Cloudmesh Cluster Instalation     #"
Echo "#################################################"
echo
Echo "#"
Echo "# Update the system"
Echo "#"
sudo apt-get update
sudo apt-get full-upgrade
sudo apt-get install -y libatlas-base-dev
sudo apt-get install -y nmap
echo
Echo "#"
Echo "# Create a Python Virtual Env ~/ENV3"
Echo "#"
python3 -m venv ~/ENV3
. ${HOME}/ENV3/bin/activate
${HOME}/ENV3/bin/pip install pip -U
which ~/ENV3/bin/python
which ~/ENV3/bin/pip
${HOME}/ENV3/bin/python3 --version
${HOME}/ENV3/bin/pip --version
Echo "#"
Echo "# Install cloudmesh-installer"
Echo "#"
${HOME}/ENV3/bin/pip install cloudmesh-installer -U
mkdir -p ${HOME}/cm
cd ${HOME}/cm
git clone https://github.com/cloudmesh/cloudmesh_pi_burn.git
cd ${HOME}/cm/cloudmesh_pi_burn
pip install -e .
cd ${HOME}/cm
${HOME}/ENV3/bin/cloudmesh-installer get pi
Echo "#"
Echo "# Add ENV3 to bashrc"
Echo "#"
cd ${HOME}
LINE="source ${HOME}/ENV3/bin/activate"
grep -qF -- "$LINE" ~/.bashrc || echo "$LINE" >> ~/.bashrc

LINE='if [ -z "$SSH_AUTH_SOCK" ] ; then eval "$(ssh-agent -s)"; fi'
grep -qF -- "$LINE" ~/.bashrc || echo "$LINE" >> ~/.bashrc

Echo "#"
Echo "# Create ssh key if it does not exist"
Echo "#"
FILE=$HOME/.ssh/id_rsa.pub
if [ ! -e "$FILE" ]; then
     yes y | ssh-keygen -q -N "" -f .ssh/id_rsa
fi
LINE="ssh-add"
grep -qF -- "$LINE" ~/.bashrc || echo "$LINE" >> ~/.bashrc

echo
Echo "Please activate with"
echo
Echo "    source ~/ENV3/bin/activate"
echo
exit 0

# </pre>

